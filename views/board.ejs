<%- contentFor('content') %>
<div class="player">
    <div class="playerStatus"></div>
    เริ่มเกมแล้ว <strong><%= player.name %></strong> !
    <span class="homelink">ถ้าไม่ใช่คุณ, <a href="/">คลิกที่นี่</a> !</span>
</div>

<!-- ปุ่มสำหรับเปิด/ปิดแถบข้าง -->
<button id="toggleSidebarBtn" class="btn btn-secondary">
    <i class="fas fa-users"></i> ผู้เล่นออนไลน์
</button>

<!-- แถบข้างสำหรับแสดงรายชื่อผู้เล่นที่ออนไลน์ -->
<div id="playerSidebar">
    <div id="onlinePlayers">
        <h4>ผู้เล่นที่ออนไลน์:</h4>
        <ul id="onlinePlayerList">
            <!-- รายชื่อผู้เล่นจะถูกแทรกโดย JavaScript -->
        </ul>
        <button id="closeSidebarBtn" class="btn btn-sm btn-danger mt-3">ปิด</button>
    </div>
</div>
<!-- Overlay สำหรับเมื่อแถบข้างเปิดอยู่ -->
<div id="sidebarOverlay"></div>


<div id="waiting" class="hidden <% if (status === '') { %>current<% } %>">
    <p>รอให้ทุกคนพร้อม ...</p>
</div>

<div id="reset">
    <p class="role hidden <% if (status == 'role') { %>appear<% } %>">คุณคือ <strong><%= player.role %></strong></p>
</div>

<div id="chooseWord" class="hidden <% if (status == 'role' && player.role === 'Maître du jeu') { %>current<% } %>">
    <form id="wordForm" method="post" name="wordForm" action="setWord" autocomplete="off">
        <div class="form-group">
            <input type="text" name="word" class="form-control" id="wordForm" style="width: 60%; display: inline;" placeholder="คำที่ต้องการให้ทาย" />
            <button type="submit" class="btn btn-warning">ส่ง</button>
            <small class="form-text">กดส่งเลยถ้าคิดคำไม่ออก เราคิดให้</small>
        </div>
    </form>
</div>

<div id="reveal">
    <button class="btn btn-warning cta hidden <% if (status == 'word' && player.role === 'ผู้ดำเนินเกม') { %>current<% } %>">เปิดเผยคำ</button>
    <div id="word" class="hidden"></div>
</div>

<div id="startGame" class="hidden  <% if (status == 'word') { %>current<% } %>">
    <% if (player.permission == 'admin') { %>
        <a href=""><i class="fas fa-play-circle"></i></a>
    <% } %>
</div>

<div id="countdown" class="hidden">
    <span id="timer"></span>
    <% if (player.permission == 'admin') { %>
        <a href=""><i class="fas fa-stop-circle"></i></a>
    <% } %>
</div>

<div id="voteForm">
    <% if (player.permission == 'admin') { %>
        <button id="displayVote1" class="btn btn-warning cta hidden <% if (status == 'vote1') { %>current<% } %>">โหวต</button>
    <% } %>
    <div id="vote1" class="hidden">
        <h4>คุณคิดว่าคนที่ทายคำได้คือผู้ทรยศหรือไม่?</h4>
        <button data-vote="1" class="btn btn-warning"><i class="fas fa-thumbs-up"></i></button>
        <button data-vote="0" class="btn btn-warning"><i class="fas fa-thumbs-down"></i></button>
    </div>
    <div id="vote1Result" class="hidden <% if (status == 'vote2') { %>current<% } %>">
        <h4>ผลการโหวต</h4>
        <span class="resultUp">
            <strong>
                <% if(resultVote1 !== null) {%><%= resultVote1.up %><% } %>
            </strong> <i class="fas fa-thumbs-up"></i>
        </span>
        <span class="resultDown">
            <strong>
                <% if(resultVote1 !== null) {%><%= resultVote1.down %><% } %>
            </strong> <i class="fas fa-thumbs-down"></i>
        </span>
    </div>
    <% if (player.permission == 'admin') { %>
        <button id="displayVote2" class="btn btn-warning cta hidden <% if (status == 'vote2') { %>current<% } %>">โหวต</button>
    <% } %>
    <div id="vote2" class="hidden">
        <h4>โหวตรอบ 2</h4>        
        <h4>คิดว่าใครคือผู้ทรยศ?</h4>
        <form class="inline-block" id="playerChoiceForm" method="post" name="playerForm" action="game">
            <div class="choices"></div>
            <button class="btn btn-warning">โหวต</button>
        </form>
    </div>
    <div id="vote2Result" class="hidden">
        <h4>ผลการโหวต</h4>
        <ul id="playerList"></ul>
        <p id="finalResult"></p>
    </div>
</div>

<div id="status" class="hidden <% if (status !== '') { %>current<% } %>">
    <p>
        <% if (status !== '') { %>
            กำลังรอ <strong>ผู้ดำเนินเกม</strong> หรือ <strong> แอดมิน </strong> ...
        <% } %>
    </p>
</div>


<%- contentFor('footer') %>
<% if (player.permission == 'admin') { %>
<div style="position:fixed; left:0; right:0; bottom:24px; z-index:10000; width:100vw; background:none; box-shadow:none; display:flex; gap:16px; justify-content:center; align-items:center;">
    <button id="showWordAndRoles" class="btn btn-info">ดูคำและบทบาททุกคน</button>
    <button class="btn btn-dark cta" id="newGame">เริ่มเกม</button>
</div>
<div id="adminRevealModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:99999; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:24px; border-radius:8px; min-width:300px; max-width:90vw; margin:40px auto;">
        <h4>คำที่ต้องทาย: <span id="modalWord"></span></h4>
        <h5>บทบาทผู้เล่น</h5>
        <ul id="modalRoles"></ul>
        <button id="closeAdminReveal" class="btn btn-danger">ปิด</button>
    </div>
</div>
<% } %>
         
<%- contentFor('script') %>
<style>
    /* filepath: c:\Users\pc\Desktop\insider-game-master\views\board.ejs */
    /* CSS สำหรับแถบข้างผู้เล่น */
    #playerSidebar {
        position: fixed;
        top: 0;
        right: -250px; /* เริ่มต้นซ่อนอยู่ด้านขวา */
        width: 250px;
        height: 100%;
        background-color: #777070; /* สีเทาเข้ม */
        color: #fff;
        padding: 15px;
        box-shadow: -3px 0 10px rgba(0,0,0,0.2);
        z-index: 10002; /* ต้องสูงกว่า overlay */
        transition: right 0.3s ease-in-out; /* เพิ่ม animation */
        overflow-y: auto; /* ทำให้สามารถ scroll ได้ถ้ามีผู้เล่นเยอะ */
    }

    #playerSidebar.open {
        right: 0; /* เลื่อนเข้ามาในจอ */
    }

    #onlinePlayers {
        /* ไม่ต้องมี margin-top, border, background-color ซ้ำซ้อนแล้ว */
        padding: 0; 
    }

    #onlinePlayers h4 {
        color: #fff; /* หัวข้อก็เป็นสีขาว */
        margin-bottom: 15px;
    }

    #onlinePlayerList {
        list-style-type: none;
        padding: 0;
        margin-bottom: 20px;
    }

    #onlinePlayerList li {
        margin-bottom: 8px;
        font-size: 1em;
        display: flex;
        align-items: center;
    }

    #onlinePlayerList li i {
        margin-right: 8px;
        font-size: 0.8em;
    }

    .status-online {
        color: #28a745; /* สีเขียวสำหรับออนไลน์ */
    }

    .status-disconnected {
        color: #ffc107; /* สีเหลืองสำหรับหลุดการเชื่อมต่อ */
    }

    /* CSS สำหรับปุ่มเปิด/ปิดแถบข้าง */
    #toggleSidebarBtn {
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 10001; /* อยู่ระหว่างเนื้อหากับ sidebar */
        background-color: #343a40; /* สีเข้มเพื่อให้ตัดกับพื้นหลัง */
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
    }

    #toggleSidebarBtn i {
        margin-right: 5px;
    }

    /* CSS สำหรับ Overlay */
    #sidebarOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5); /* พื้นหลังสีดำโปร่งใส */
        z-index: 10000; /* อยู่ใต้ sidebar แต่เหนือกเนื้อหา */
        display: none; /* เริ่มต้นซ่อนอยู่ */
    }

    /* ปรับแต่งสำหรับมือถือ (ปรับขนาดปุ่ม, แถบข้างอาจเต็มจอได้) */
    @media (max-width: 768px) {
        #playerSidebar {
            width: 80%; /* บนมือถืออาจจะกว้างขึ้น */
            right: -80%;
            padding: 10px;
        }

        #playerSidebar.open {
            right: 0;
        }

        #toggleSidebarBtn {
            top: 10px;
            right: 10px;
            padding: 6px 10px;
            font-size: 0.8em;
        }

        #onlinePlayerList li {
            font-size: 0.9em;
        }
    }
</style>
<script>
    var socket = io(); // จะเชื่อมต่อกับ host ปัจจุบันอัตโนมัติ

    // ฟังก์ชันสำหรับเปิด/ปิดแถบข้าง
    function toggleSidebar() {
        $('#playerSidebar').toggleClass('open');
        $('#sidebarOverlay').toggle(); // สลับการแสดงผลของ overlay
    }

    function displayPlayerStatus(online, offline) {
        // ฟังก์ชันนี้ถูกใช้เพื่อแสดงวงกลมสถานะ online/offline ด้านบน
        // การอัปเดตรายชื่อผู้เล่นด้านล่างจะใช้ updateOnlinePlayerList แทน
        // ถ้าไม่ต้องการวงกลมด้านบนแล้ว สามารถลบโค้ดส่วนนี้ออกได้
        $('.playerStatus').html('');
        for (var i = 0; i < online; i++) {
            $('.playerStatus').append('<i class="fas fa-circle online"></i>')
        }
        for (var i = 0; i < offline; i++) {
            $('.playerStatus').append('<i class="fas fa-circle offline"></i>')
        }
    }

    // ฟังก์ชันสำหรับอัปเดตรายชื่อผู้เล่นที่ออนไลน์
    // รับข้อมูลเป็น Array ของ object { name: string, status: 'online' | 'disconnected' }
    function updateOnlinePlayerList(onlinePlayers) {
        $('#onlinePlayerList').empty();
        if (onlinePlayers.length === 0) {
            $('#onlinePlayerList').append('<li>ไม่มีผู้เล่นออนไลน์ในขณะนี้</li>');
        } else {
            onlinePlayers.forEach(function(player) {
                const statusIconClass = player.status === 'online' ? 'status-online' : 'status-disconnected';
                const statusText = player.status === 'online' ? '' : ' (หลุดการเชื่อมต่อ)';
                $('#onlinePlayerList').append(`<li><i class="fas fa-circle ${statusIconClass}"></i> ${player.name}${statusText}</li>`);
            });
        }
    }
    
    $(function() {
        // Event Listeners สำหรับแถบข้าง
        $('#toggleSidebarBtn').on('click', toggleSidebar);
        $('#closeSidebarBtn').on('click', toggleSidebar);
        $('#sidebarOverlay').on('click', toggleSidebar); // คลิกที่ overlay เพื่อปิดแถบข้าง

        // ปุ่มแอดมินดูคำและบทบาท (footer)
        $(document).on('click', '#showWordAndRoles', function() {
            socket.emit('admin_request_word_roles');
        });
        $(document).on('click', '#closeAdminReveal', function() {
            $('#adminRevealModal').hide();
        });
        socket.on('admin_word_roles', function(data) {
            $('#modalWord').text(data.word);
            $('#modalRoles').empty();
            data.players.forEach(function(p) {
                $('#modalRoles').append('<li>' + p.name + ' : ' + p.role + '</li>');
            });
            $('#adminRevealModal').show();
        });
    });

    function soundNotify(notifType) {
        let audiof;
        switch (notifType) {
          case 'message':
            audiof = new Audio('/static/sound/message.mp3');
            break;
          case 'mysterious':
            audiof = new Audio('/static/sound/mysterious.mp3');
            break;
          case 'ding':
            audiof = new Audio('/static/sound/ding.mp3');
            break;
          case 'dong':
            audiof = new Audio('/static/sound/dong.mp3');
            break;
          case 'tada':
            audiof = new Audio('/static/sound/tada.mp3');
            break;
          default:
            audiof = new Audio('/static/sound/ding.mp3');
        }
        
        audiof.play();
    }

    function addPlayerVote(player, checked) {
        let templateVote = '<div class="form__group optionalClass"><div class="form__radio-group"><input checked type="radio" class="form__radio-input" id="playerName" name="player" value="playerName"><label for="playerName" class="form__radio-label">playerName</label></div></div>';

        if(!checked) {
            templateVote = templateVote.replace('checked ', '');
        }
        templateVote = templateVote.replace('optionalClass', player.isGhost ? 'ghost' : '');

        $('#vote2 form .choices').append(templateVote.replace(/playerName/g, player.name));
    }

    function updateCountdown(counter) {
        $("#timer").html(formatCountdown(counter));
    }

    function getResultIssue(result) {
        let message = '';
        if (result.hasTraitor) {
            // กรณีมีผู้ทรยศในเกม
            if (result.hasWon) {
                message = `เยี่ยมมาก! พลเมืองชนะแล้ว! <br/>ผู้ทรยศคือ: ${result.finalTraitorName}`;
            } else {
                message = `ผู้ทรยศชนะ! พลเมืองโหวตพลาด <br/>ผู้ทรยศคือ: ${result.finalTraitorName}`;
            }
        } else {
            // กรณีไม่มีผู้ทรยศในเกม
            if (result.hasWon) {
                message = `เยี่ยมมาก! พลเมืองชนะแล้ว! <br/>ไม่มีผู้ทรยศในเกมนี้ (เจอ Ghost Player)`;
            } else {
                message = `พลเมืองโหวตพลาด! ไม่มีผู้ทรยศในเกมนี้ แต่คุณก็ยังโหวตพลาด`;
            }
        }
        return message;
    }

    $(function() {

        $('.appear').fadeIn().delay(3000).fadeOut();

        $("#wordForm").submit(function(e) {
            $.post($(this).attr('action'),
            {
              word: $("#wordForm input[name='word']").val()
            },
            function(data, status){
              $("#chooseWord").fadeOut();
              $('#reveal button').fadeIn(1000);
            });
            e.preventDefault();
        });

        $( "#newGame").click(function(){
            socket.emit('resetGame');
            $(this).attr("disabled", true);
        });

        $( "#startGame a").click(function(e){
            socket.emit('startGame');
            $("#startGame").fadeOut();
            $("#countdown").fadeIn();
            e.preventDefault();
        });

        $( "#countdown a").click(function(e){
            socket.emit('wordFound');
            e.preventDefault();
        });

        $( "#displayVote1").click(function(e){
            socket.emit('displayVote1');
        });

        $( "#displayVote2").click(function(e){
            socket.emit('displayVote2');
        });

        $( "#vote1 button").click(function(e){
            $('.hidden').hide();
            socket.emit('vote1', {player: '<%= player.name %>', vote: $(this).data('vote')});
            $(this).attr("disabled", true);
        });

        $( "#vote2 button").click(function(e){
            $('.hidden').hide();
            socket.emit('vote2', {player: '<%= player.name %>', vote: $("#vote2 input[name='player']:checked").val()});
            e.preventDefault();
            $(this).attr("disabled", true);
        });

        $( "#reveal button").click(function(){
            socket.emit('revealWord');
            $(this).attr("disabled", true).hide();
        });

        // ส่ง newPlayer เมื่อโหลดหน้าครั้งแรก
        socket.emit('newPlayer', '<%= player.name %>');

        // เมื่อ Socket.IO reconnect อัตโนมัติ, ให้ส่ง newPlayer event อีกครั้งเพื่อ rejoin
        socket.on('reconnect', function() {
            console.log('Socket reconnected, attempting to rejoin as <%= player.name %>');
            socket.emit('newPlayer', '<%= player.name %>'); 
        });

        // รับข้อมูลรายชื่อผู้เล่นที่ออนไลน์จาก Server
        socket.on('onlinePlayerListUpdate', function(onlinePlayers) {
            updateOnlinePlayerList(onlinePlayers);
        });

        // จัดการกรณีที่ชื่อถูกใช้งานอยู่
        socket.on('nameInUse', function(data) {
            Swal.fire({
                icon: 'error',
                title: 'ชื่อถูกใช้งานแล้ว!',
                text: data.message,
                confirmButtonText: 'ตกลง'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/'; // Redirect กลับไปหน้าเลือกผู้เล่น
                }
            });
        });

        socket.on('newRole', function(data) {
            $('.hidden').hide();
            $('#word').html('');
            $('#vote2 form .choices').html('');
            $('#reveal button, #newGame, #vote1 button, #vote2 button').attr("disabled", false);

            $.each(data.players, function(i, obj) {
                if(obj.name == '<%= player.name %>') {
                    $('.role strong').html(obj.role);
                    $('#reset .role').fadeIn(1000).delay(6000).fadeOut("slow", function(){
                        // ตรวจสอบบทบาทจริง ไม่ใช่ 'Maître du jeu' ที่เป็นภาษาฝรั่งเศส
                        if(obj.role === 'ผู้ดำเนินเกม') { 
                            $("#chooseWord").fadeIn();
                        }
                    });
                    return false;
                };
            });
            soundNotify('mysterious');
        });

        socket.on('revealWord', function(data) {
            $.each(data.players, function(i, obj) {
                if(obj.name == '<%= player.name %>') {
                    if(obj.role == 'ผู้ดำเนินเกม' || obj.role == 'ผู้ทรยศ') {
                        $('#word').html("<span>คำที่ต้องทายคือ <strong>"+data.word+"</strong></span>");
                    } else {
                        $('#word').html("<span>ผู้ดำเนินเกมและผู้ทรยศ <br />จะเห็นคำนี้</span>");
                    }
                    return false;
                };
            });

            $('#word').fadeIn(1000).delay(5000).fadeOut("slow", function() {
                $("#startGame").fadeIn();
            });
            soundNotify('message');
        });

        socket.on('wordFound', function() {
            $('.hidden').hide();
            $('#displayVote1').fadeIn();
        });

        socket.on('displayVote1', function() {
            $('.hidden').hide();
            $('#vote1').fadeIn();
            $("#vote1 button").attr("disabled", false);
            soundNotify('message');
        });

        socket.on('displayVote2', function(players) {
            $('.hidden').hide();
            $("#vote2 button").attr("disabled", false);
            $('#vote2 form .choices').html('');
            players.forEach(function(votePlayer, index) {
                let checked = (index === 0 ? true : false);
                addPlayerVote(votePlayer, checked);
            });
            $('#vote2').fadeIn();
        });
        
        socket.on('vote1Ended', function(result) {
            $('.hidden').hide();
            $('#vote1Result').fadeIn();
            $('#vote1Result .resultUp strong').html(result.up);
            $('#vote1Result .resultDown strong').html(result.down);
            $('#displayVote2').fadeIn();
            soundNotify('tada');
        });

        socket.on('vote2Ended', function(result) {
            $('.hidden').hide();
            $('#vote2Result ul').html('');
            result.voteDetail.forEach(function(votePlayer, index) {
                $('#vote2Result ul').append('<li>'+votePlayer.name+' ('+votePlayer.nbVote2+')</li>');
            });
            finalResult = getResultIssue(result);
            $('#vote2Result #finalResult').html(finalResult);
            $('#vote2Result').fadeIn();
            soundNotify('tada');
        });

        socket.on('playerStatusUpdate', function(playerStatus) {
            displayPlayerStatus(playerStatus.online, playerStatus.offline)
        });

        socket.on('countdownUpdate', function(counter) {
            $('.hidden').hide();
            updateCountdown(counter);
            $("#countdown").show();
        });

        socket.on('startGame', function() {
            $('.hidden').hide();
            $("#countdown").fadeIn();
            soundNotify('ding');
        });

    });
</script>
